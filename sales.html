<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moniteo Umbrella - Ventes Pro</title>

    <script>
        if (sessionStorage.getItem('isLogged') !== 'true') {
            window.location.href = "index.html";
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
 <style>
 /* Couleurs pour le Mode Sombre */
body.dark-mode {
    --bg-body: #0f172a;       /* Fond sombre */
    --bg-card: #1e293b;       /* Cartes sombres */
    --text-main: #f1f5f9;     /* Texte blanc/gris clair */
    --text-light: #94a3b8;    /* Texte secondaire gris */
    --border-soft: #334155;   /* Bordures discr√®tes */
}

/* On force le changement de couleur sur les √©l√©ments critiques */
body.dark-mode .card, 
body.dark-mode .header-flex {
    background-color: var(--bg-card);
    color: var(--text-main);
    border-color: var(--border-soft);
}

body.dark-mode input, 
body.dark-mode select {
    background-color: #0f172a;
    color: white;
    border-color: var(--border-soft);
}
        /* --- VARIABLES ET TH√àMES --- */
        :root {
            --primary:#1f3c63; --secondary:#3b82f6; --success:#10b981; --danger:#ef4444;
            --text-main:#1e293b; --text-light:#64748b; --bg-body:#f1f5f9; --bg-card:#ffffff;
            --border-soft:#e2e8f0; --sidebar-w:260px;
        }

        /* --- RESET ET BASE --- */
        * { margin:0; padding:0; box-sizing:border-box; font-family:Inter,sans-serif; }
        
        body { 
            display:flex; 
            height: 100vh;
            overflow: hidden; 
            background:var(--bg-body); 
            color:var(--text-main); 
            transition: 0.3s; 
        }

        .icon { 
            width: 20px; 
            height: 20px; 
            min-width: 20px; 
            stroke: currentColor; 
            stroke-width: 2; 
            fill: none; 
        }

        /* --- SIDEBAR (Calqu√© sur Dashboard) --- */
        .sidebar {
            position: relative; 
            width: var(--sidebar-w); 
            height: 100vh; 
            background: var(--primary);
            color: #fff; 
            padding: 1rem; 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .sidebar.collapsed { width: 80px; }
        .sidebar.collapsed span, 
        .sidebar.collapsed .logo-full { display: none; }
        .sidebar.collapsed .logo-short { display: block; }

        .logo-box { 
            padding: 1rem 0; 
            text-align: center; 
            border-bottom: 1px solid rgba(255,255,255,.1); 
            margin-bottom: 1.5rem; 
        }

        .logo-full { width: 140px; height: auto; transition: 0.3s; }
        .logo-short { display: none; width: 70px; margin: 0 auto; transition: 0.3s; }

        .nav-links { list-style:none; flex:1; overflow-y: auto; }
        .nav-links a {
            display:flex; align-items:center; gap:12px; padding:12px 15px; border-radius:10px;
            text-decoration:none; color:rgba(255,255,255,.7); font-size:.9rem; transition:.2s;
            border-left: 3px solid transparent;
        }
        .nav-links a:hover, .nav-links a.active { 
            background:rgba(255,255,255,0.15); 
            color:#fff; 
            border-left: 3px solid var(--secondary);
        }

        /* --- CONTENU PRINCIPAL --- */
        .main-content { 
            flex-grow: 1;
            height: 100vh;
            overflow-y: auto; 
            padding: 2rem; 
            transition: .3s; 
            -webkit-overflow-scrolling: touch;
        }

        .header-flex { 
            display:flex; justify-content:space-between; align-items:center; 
            background:var(--bg-card); padding:1rem 1.5rem; border-radius:12px; 
            box-shadow:0 1px 3px rgba(0,0,0,.1); margin-bottom:2rem; 
        }

        .card { background:var(--bg-card); padding:1.5rem; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border-soft); margin-bottom: 1.5rem; }
        
        /* --- TABLES --- */
        .table-wrapper { overflow-x: auto; margin-top: 1rem; border-radius: 8px; border: 1px solid var(--border-soft); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 700px; }
        th { background: #f8fafc; color: var(--text-light); padding: 12px; text-align: left; border-bottom: 2px solid #edf2f7; }
        td { padding: 10px; border-bottom: 1px solid #edf2f7; }

        /* --- ACTIONS & UI --- */
        .action-bar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
        
        button { 
            padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; 
            font-weight: 600; font-size: 0.85rem; transition: 0.2s; white-space: nowrap;
        }
        .btn-main { background: var(--primary); color: white; }
        .btn-outline { background: white; color: var(--text-main); border: 1px solid var(--border-soft); }
        .btn-danger { background: #fee2e2; color: var(--danger); }

        .summary-banner {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 1.5rem; background: var(--primary); color: white;
            padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;
        }
        .summary-banner small { color: rgba(255,255,255,0.7); text-transform: uppercase; font-size: 0.7rem; }
        .summary-banner p { font-size: 1.4rem; font-weight: 700; margin-top: 5px; }

        .logout-box { border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem; }
        .logout-btn {
            display: flex; align-items: center; gap: 12px; padding: 12px 15px;
            text-decoration: none; color: #ff6b6b; font-weight: 600; font-size: 0.9rem;
        }

        /* --- RESPONSIVE (Strictement identique au Dashboard) --- */
        @media (max-width: 1024px) {
            :root { --sidebar-w: 80px; }
            .sidebar span, .logo-full { display: none; }
            .sidebar .logo-short { display: block; }
        }

        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            .sidebar { 
                width: 100%; height: auto; position: sticky; top: 0; 
                flex-direction: row; padding: 0.5rem; align-items: center;
            }
            .sidebar.collapsed { width: 100%; height: auto; }
            .logo-box { border: none; margin: 0; padding: 0 1rem; }
            .nav-links { display: flex; flex-direction: row; overflow-x: auto; scrollbar-width: none; }
            .nav-links::-webkit-scrollbar { display: none; }
            .nav-links a { padding: 8px 12px; white-space: nowrap; }
            .nav-links span { display: none; } /* On cache le texte sur mobile pour fluidit√© */
            
            .logout-box { display: none; }
            
            .main-content { padding: 1rem; height: auto; }
            .header-flex { flex-direction: column; gap: 1rem; text-align: center; }
            .summary-banner { grid-template-columns: 1fr 1fr; gap: 10px; padding: 1rem; }
            .summary-banner p { font-size: 1.1rem; }
        }
    </style>
        </head>
<body>

    <nav class="sidebar" id="sidebar">
        <div class="logo-box">
            <img src="https://i.postimg.cc/bJjy56Lq/Moniteo_1_removebg_preview.png" class="logo-full" alt="Logo">
            <img src="https://i.postimg.cc/xjgBzxr0/Moniteo-3-removebg-preview.png" class="logo-short" alt="M">
        </div>
        <ul class="nav-links">
            <li><a href="dashboard.html"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg> <span>Accueil</span></a></li>
            <li><a href="sales.html" class="active"><svg class="icon" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg> <span>Ventes</span></a></li>
            <li><a href="inventory.html"><svg class="icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg> <span>Inventaire</span></a></li>
            <li><a href="expenses.html"><svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg> <span>D√©penses</span></a></li>
            <li><a href="staff.html"><svg class="icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg> <span>Staff</span></a></li>
            <li><a href="reporting.html"><svg class="icon" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg> <span>Reporting</span></a></li>
            <li><a href="history.html"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <span>Historique</span></a></li>
            <li><a href="setting.html"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg> <span>Param√®tres</span></a></li>
        </ul>
        <div class="logout-box">
            <a href="#" onclick="logout(); return false;" class="logout-btn">
                <svg class="icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                <span>D√©connexion</span>
            </a>
        </div>
    </nav>

    <main class="main-content" id="mainContent">
        <header class="header-flex">
            <h2>Gestion des Ventes</h2>
            <div>
                Devise: 
                <select id="currencySelect" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border-soft);">
                    <option value="‚Ç¨">‚Ç¨ Euro</option>
                    <option value="$">$ Dollar</option>
                    <option value="FC">FC Franc</option>
                </select>
            </div>
        </header>

        <div class="summary-banner">
            <div><small>Total Ventes</small><p id="totalSales">0</p></div>
            <div><small>B√©n√©fice</small><p id="totalProfit">0</p></div>
            <div><small>Produits</small><p id="totalQuantity">0</p></div>
        </div>

        <div class="action-bar">
    <button class="btn-main" onclick="addRow()">+ Ajouter Vente</button>
    <button class="btn-outline" onclick="undo()">Annuler (Undo)</button>
    
    <button class="btn-outline" onclick="exportExcel()">Exporter Excel</button>
    <button class="btn-outline" onclick="exportPDF()">Exporter PDF</button>
    <button class="btn-outline" onclick="document.getElementById('importSales').click()">Importer Excel</button>
    <input type="file" id="importSales" style="display:none" accept=".xlsx,.xls">
    
    <button class="btn-outline" style="border-color: #3b82f6; color: #3b82f6;" onclick="downloadBackup()">Sauvegarder</button>
    <button class="btn-outline" style="border-color: #f59e0b; color: #f59e0b;" onclick="document.getElementById('importBackup').click()">Restaurer</button>
    <input type="file" id="importBackup" style="display:none" accept=".json">

    <button class="btn-danger" onclick="deleteSelectedRow()">Supprimer</button>
    <button class="btn-danger" onclick="clearTable()">Nettoyer</button>
    
    <button class="btn-main" style="background:#10b981" onclick="closeDay()">Cl√¥turer Journ√©e</button>
</div>
        <div class="card">
            <input type="text" id="filterProduct" oninput="filterTable()" placeholder="Filtrer par produit..." style="width:100%; padding: 12px; border: 1px solid var(--border-soft); border-radius: 10px; margin-bottom: 1rem;">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>S√©lect</th>
                            <th>Produit</th>
                            <th>Date</th>
                            <th>Achat</th>
                            <th>Vente</th>
                            <th>Qt√©</th>
                            <th>B√©n√©fice</th>
                        </tr>
                    </thead>
                    <tbody id="salesTable"></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>Analyses Graphiques</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-top: 1rem;">
                <canvas id="salesChart" style="max-height: 250px;"></canvas>
                <canvas id="profitChart" style="max-height: 250px;"></canvas>
            </div>
        </div>

        <div class="card" style="border-left: 4px solid var(--danger);">
            <h3 style="color: var(--danger);">Alertes Stock</h3>
            <ul id="alertList" style="margin-top: 10px; font-size: 0.85rem; padding-left: 20px;"></ul>
        </div>
    </main>

   <script>
        // --- DONNEES ---
        let salesData = JSON.parse(localStorage.getItem('salesData')) || [];
        let inventoryData = JSON.parse(localStorage.getItem('inventoryData')) || [];
        let historyData = JSON.parse(localStorage.getItem('historyData')) || [];
        let undoStack = [];
        let currentCurrency = localStorage.getItem('currency') || '‚Ç¨';
        // √Ä mettre au d√©but de vos fichiers .html (Ventes, Staff, Inventaire)
        function applyGlobalSettings() {
    const config = JSON.parse(localStorage.getItem('moniteo_config')) || {};
    
    // 1. Appliquer le th√®me (Sombre/Clair)
    if (config.darkMode) {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }

    // 2. Mettre √† jour la devise globale si n√©cessaire
    if (config.currency) {
        localStorage.setItem('currency', config.currency);
        // Si un s√©lecteur de devise existe sur la page, on le met √† jour
        const select = document.getElementById('currencySelect');
        if (select) select.value = config.currency;
    }

    // 3. Mettre √† jour le titre du dashboard avec le nom de l'entreprise
    const brandName = document.querySelector('.header-flex h2');
    if (brandName && config.name) {
        brandName.innerHTML = `${brandName.innerText} <small style="font-size: 0.6em; color: var(--secondary)">| ${config.name}</small>`;
    }
}

// Ex√©cuter au chargement de chaque page
document.addEventListener('DOMContentLoaded', applyGlobalSettings);
        // --- INITIALISATION ---
        document.getElementById('currencySelect').value = currentCurrency;
        document.getElementById('currencySelect').addEventListener('change', e => {
            currentCurrency = e.target.value;
            localStorage.setItem('currency', currentCurrency);
            renderTable();
        });

        function handleResponsiveSidebar() {
            const width = window.innerWidth;
            const sb = document.getElementById('sidebar');
            if (sb) {
                if (width <= 1024) sb.classList.add('collapsed');
                else sb.classList.remove('collapsed');
            }
        }

        window.addEventListener('resize', handleResponsiveSidebar);
        window.addEventListener('DOMContentLoaded', () => {
            handleResponsiveSidebar();
            renderTable();
        });

        // --- ACTIONS ---
        function addRow() {
            saveUndo();
            // Initialisation avec une ligne vide
            salesData.push({product:'', date:new Date().toISOString().slice(0,10), buy:0, sell:0, qty:1});
            renderTable();
        }

        function deleteSelectedRow() {
            const table = document.getElementById('salesTable');
            const checkboxes = table.querySelectorAll('input[type="checkbox"]');
            let newSalesData = [];
            
            saveUndo();
            checkboxes.forEach((cb, index) => {
                if (!cb.checked) {
                    newSalesData.push(salesData[index]);
                }
            });

            if (newSalesData.length === salesData.length) {
                alert("Veuillez s√©lectionner au moins une ligne √† supprimer.");
                return;
            }

            salesData = newSalesData;
            renderTable();
        }

        function saveUndo() {
            undoStack.push(JSON.stringify(salesData));
            if(undoStack.length > 20) undoStack.shift();
        }

        function undo() {
            if(undoStack.length > 0) {
                salesData = JSON.parse(undoStack.pop());
                renderTable();
            } else alert("Rien √† annuler !");
        }

        // --- EXPORTS ---
        function exportExcel() {
            if (salesData.length === 0) return alert("Tableau vide !");
            const ws = XLSX.utils.json_to_sheet(salesData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ventes");
            XLSX.writeFile(wb, "Ventes_Moniteo.xlsx");
        }

        function exportPDF() {
            if (salesData.length === 0) return alert("Tableau vide !");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Rapport de Ventes - Moniteo Umbrella", 14, 15);
            
            const rows = salesData.map(s => [
                s.product, s.date, s.buy, s.sell, s.qty, ((parseFloat(s.sell) - parseFloat(s.buy)) * parseInt(s.qty)).toFixed(2)
            ]);

            doc.autoTable({
                head: [['Produit', 'Date', 'Achat', 'Vente', 'Qt√©', 'B√©n√©fice']],
                body: rows,
                startY: 20
            });
            doc.save("Ventes.pdf");
        }

        // Action de sauvegarde de s√©curit√© (Backup JSON)
        function downloadBackup() {
            const data = {
                sales: salesData,
                inventory: inventoryData,
                history: historyData,
                backupDate: new Date().toLocaleString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_moniteo_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function clearTable() {
            if(confirm("Effacer tout le tableau ?")) {
                saveUndo();
                salesData = [];
                renderTable();
            }
        }

        // --- CALCULS & RENDU ---
        function renderTable(filter = '') {
            const tbody = document.getElementById('salesTable');
            if(!tbody) return;
            tbody.innerHTML = '';
            let totalS = 0, totalP = 0, totalQ = 0;

            salesData.forEach((s, index) => {
                if(s.product.toLowerCase().includes(filter.toLowerCase())) {
                    const profit = (parseFloat(s.sell) - parseFloat(s.buy)) * parseInt(s.qty || 0);
                    totalS += parseFloat(s.sell || 0) * parseInt(s.qty || 0);
                    totalP += profit;
                    totalQ += parseInt(s.qty || 0);

                    // G√©n√©ration des options avec INDICATEURS VISUELS DE STOCK
                    let options = `<option value="">-- Choisir --</option>`;
                    inventoryData.forEach(item => {
                        const isSelected = (item.product === s.product) ? 'selected' : '';
                        
                        // D√©termination de l'√©mojis selon le stock
                        let statusEmoji = "üü¢"; // Stock OK
                        if (item.qty <= 0) statusEmoji = "üî¥"; // Rupture
                        else if (item.qty <= 5) statusEmoji = "üü†"; // Critique
                        
                        options += `<option value="${item.product}" ${isSelected}>
                            ${statusEmoji} ${item.product} (Dispo: ${item.qty})
                        </option>`;
                    });

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="checkbox"></td>
                        <td>
                            <select onchange="autoFillFromInventory(${index}, this.value)" style="width:100%; border:none; background:transparent; font-size:inherit; color:inherit; outline:none; font-weight:500;">
                                ${options}
                                <option value="${s.product}" ${s.product && !inventoryData.find(i=>i.product===s.product) ? 'selected' : ''}>${s.product ? '‚ùì ' + s.product : 'Hors Inventaire'}</option>
                            </select>
                        </td>
                        <td contenteditable="true" onblur="updateRowData(${index}, 2, this)">${s.date}</td>
                        <td contenteditable="true" onblur="updateRowData(${index}, 3, this)">${s.buy}</td>
                        <td contenteditable="true" onblur="updateRowData(${index}, 4, this)">${s.sell}</td>
                        <td contenteditable="true" onblur="updateRowData(${index}, 5, this)">${s.qty}</td>
                        <td style="font-weight:bold; color:${profit >= 0 ? '#10b981' : '#ef4444'}">${profit.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                }
            });

            document.getElementById('totalSales').textContent = totalS.toLocaleString() + " " + currentCurrency;
            document.getElementById('totalProfit').textContent = totalP.toLocaleString() + " " + currentCurrency;
            document.getElementById('totalQuantity').textContent = totalQ;

            updateAlerts();
            localStorage.setItem('salesData', JSON.stringify(salesData));
            updateCharts();
        }

        // Liaison Inventaire : Remplissage automatique des prix
        function autoFillFromInventory(index, productName) {
            const item = inventoryData.find(i => i.product === productName);
            if (item) {
                salesData[index].product = item.product;
                salesData[index].buy = item.buyPrice || item.buy || 0;
                salesData[index].sell = item.sellPrice || item.sell || 0;
            } else {
                salesData[index].product = productName;
            }
            renderTable();
        }

        function updateRowData(index, cellIndex, element) {
            const val = element.textContent;
            if(cellIndex === 1) salesData[index].product = val;
            if(cellIndex === 2) salesData[index].date = val;
            if(cellIndex === 3) salesData[index].buy = parseFloat(val.replace(',','.')) || 0;
            if(cellIndex === 4) salesData[index].sell = parseFloat(val.replace(',','.')) || 0;
            if(cellIndex === 5) salesData[index].qty = parseInt(val) || 0;
            
            renderTable(document.getElementById('filterProduct').value);
        }

        function updateAlerts() {
            const alertList = document.getElementById('alertList');
            if(!alertList) return;
            alertList.innerHTML = '';
            inventoryData.forEach(i => {
                if(i.qty <= 5) alertList.innerHTML += `<li>‚ö†Ô∏è <strong>${i.product}</strong> : stock critique (${i.qty})</li>`;
            });
        }

        function filterTable() {
            renderTable(document.getElementById('filterProduct').value);
        }

        // --- GRAPHIQUES ---
        let salesChart, profitChart;
        function updateCharts() {
            const canvasSales = document.getElementById('salesChart');
            const canvasProfit = document.getElementById('profitChart');
            if(!canvasSales || !canvasProfit) return;

            const lastItems = salesData.slice(-7);
            const labels = lastItems.map(s => s.product || '...');
            const qtyData = lastItems.map(s => s.qty);
            const profData = lastItems.map(s => (parseFloat(s.sell) - parseFloat(s.buy)) * parseInt(s.qty || 0));

            if(salesChart) salesChart.destroy();
            salesChart = new Chart(canvasSales, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Quantit√©s', data: qtyData, backgroundColor: '#1f3c63' }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            if(profitChart) profitChart.destroy();
            profitChart = new Chart(canvasProfit, {
                type: 'line',
                data: { labels, datasets: [{ label: 'B√©n√©fice', data: profData, borderColor: '#10b981', tension:0.3, fill: true, backgroundColor:'rgba(16,185,129,0.1)' }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function logout() {
            if(confirm("Se d√©connecter ?")) {
                sessionStorage.clear();
                window.location.href = "index.html";
            }
        }

        // Cl√¥ture avec d√©duction r√©elle des stocks
        function closeDay(){
            if(salesData.length === 0) return alert("Aucune donn√©e √† cl√¥turer.");
            if(confirm("Cl√¥turer la journ√©e ? Cela d√©duira les stocks et archivera les ventes.")){
                
                // D√©duction des stocks dans inventoryData
                salesData.forEach(sale => {
                    const invItem = inventoryData.find(i => i.product === sale.product);
                    if(invItem) {
                        invItem.qty = parseInt(invItem.qty) - parseInt(sale.qty);
                    }
                });
                localStorage.setItem('inventoryData', JSON.stringify(inventoryData));

                // Archivage historique
                historyData.push({
                    date: new Date().toISOString().slice(0,10), 
                    sales: [...salesData],
                    totalRevenue: document.getElementById('totalSales').textContent
                });
                localStorage.setItem('historyData', JSON.stringify(historyData));
                
                // R√©initialisation
                salesData = [];
                renderTable();
                alert("Journ√©e cl√¥tur√©e ! Stocks mis √† jour.");
            }
        }

        // --- IMPORTATION EXCEL ---
        document.getElementById('importSales').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) return alert("Le fichier est vide.");

                    saveUndo();
                    const importedSales = jsonData.map(row => ({
                        product: row.Produit || row.product || "Import√©",
                        date: row.Date || row.date || new Date().toISOString().slice(0, 10),
                        buy: parseFloat(row.Achat || row.buy || 0),
                        sell: parseFloat(row.Vente || row.sell || 0),
                        qty: parseInt(row.Qt√© || row.qty || 0)
                    }));

                    salesData = [...salesData, ...importedSales];
                    renderTable();
                    alert(`${importedSales.length} ventes import√©es !`);
                } catch (error) {
                    alert("Erreur de format Excel.");
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // --- RESTAURATION DU BACKUP GLOBAL ---
        document.getElementById('importBackup').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!confirm("Attention : Restaurer un backup √©crasera toutes vos donn√©es actuelles (Ventes, Inventaire et Historique). Continuer ?")) {
                this.value = ""; 
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.sales && importedData.inventory && importedData.history) {
                        salesData = importedData.sales;
                        inventoryData = importedData.inventory;
                        historyData = importedData.history;

                        localStorage.setItem('salesData', JSON.stringify(salesData));
                        localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
                        localStorage.setItem('historyData', JSON.stringify(historyData));

                        renderTable();
                        alert("Syst√®me restaur√© avec succ√®s depuis le backup du : " + (importedData.backupDate || "Date inconnue"));
                    } else {
                        throw new Error("Format de fichier invalide.");
                    }
                } catch (error) {
                    console.error(error);
                    alert("Erreur : Le fichier de backup est corrompu ou invalide.");
                }
            };
            reader.readAsText(file);
        });    
        function validateSale(productName, quantitySold) {
    let sales = JSON.parse(localStorage.getItem('salesData')) || [];
    
    // On ajoute la vente avec un marqueur de temps
    sales.push({
        product: productName,
        qty: parseInt(quantitySold),
        timestamp: Date.now() // Crucial pour la synchro
    });
    
    localStorage.setItem('salesData', JSON.stringify(sales));
    alert("Vente enregistr√©e ! Le stock sera mis √† jour.");
}
  </script>
</body>
</html>
