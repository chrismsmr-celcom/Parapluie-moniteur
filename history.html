<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moniteo Umbrella - Historique Pro</title>

    <script>
        if (sessionStorage.getItem('isLogged') !== 'true') {
            window.location.href = "index.html";
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <style>
    /* Couleurs pour le Mode Sombre */
body.dark-mode {
    --bg-body: #0f172a;       /* Fond sombre */
    --bg-card: #1e293b;       /* Cartes sombres */
    --text-main: #f1f5f9;     /* Texte blanc/gris clair */
    --text-light: #94a3b8;    /* Texte secondaire gris */
    --border-soft: #334155;   /* Bordures discr√®tes */
}

/* On force le changement de couleur sur les √©l√©ments critiques */
body.dark-mode .card, 
body.dark-mode .header-flex {
    background-color: var(--bg-card);
    color: var(--text-main);
    border-color: var(--border-soft);
}

body.dark-mode input, 
body.dark-mode select {
    background-color: #0f172a;
    color: white;
    border-color: var(--border-soft);
}
        /* --- VARIABLES ET TH√àMES --- */
        :root {
            --primary:#1f3c63; --secondary:#3b82f6; --success:#10b981; --danger:#ef4444;
            --text-main:#1e293b; --text-light:#64748b; --bg-body:#f1f5f9; --bg-card:#ffffff;
            --border-soft:#e2e8f0; --sidebar-w:260px;
        }

        /* --- RESET ET BASE --- */
        * { margin:0; padding:0; box-sizing:border-box; font-family:Inter,sans-serif; }
        
        body { 
            display:flex; 
            height: 100vh;
            overflow: hidden; 
            background:var(--bg-body); 
            color:var(--text-main); 
            transition: 0.3s; 
        }

        .icon { 
            width: 20px; height: 20px; min-width: 20px; 
            stroke: currentColor; stroke-width: 2; fill: none; 
        }

        /* --- SIDEBAR --- */
        .sidebar {
            position: relative; width: var(--sidebar-w); height: 100vh; 
            background: var(--primary); color: #fff; padding: 1rem; 
            display: flex; flex-direction: column; flex-shrink: 0;
            transition: all 0.3s ease; z-index: 1000;
        }

        .sidebar.collapsed { width: 80px; }
        .sidebar.collapsed span, .sidebar.collapsed .logo-full { display: none; }
        .sidebar.collapsed .logo-short { display: block; }

        .logo-box { 
            padding: 1rem 0; 
            text-align: center; 
            border-bottom: 1px solid rgba(255,255,255,.1); 
            margin-bottom: 1.5rem; 
        }

        .logo-full { width: 140px; height: auto; transition: 0.3s; }
        .logo-short { display: none; width: 70px; margin: 0 auto; transition: 0.3s; }

        .nav-links { list-style:none; flex:1; overflow-y: auto; }
        .nav-links a {
            display:flex; align-items:center; gap:12px; padding:12px 15px; border-radius:10px;
            text-decoration:none; color:rgba(255,255,255,.7); font-size:.9rem; transition:.2s;
            border-left: 3px solid transparent;
        }
        .nav-links a:hover, .nav-links a.active { 
            background:rgba(255,255,255,0.15); color:#fff; 
            border-left: 3px solid var(--secondary);
        }

        /* --- CONTENU PRINCIPAL --- */
        .main-content { 
            flex-grow: 1; height: 100vh; overflow-y: auto; 
            padding: 2rem; transition: .3s; 
        }

        .header-flex { 
            display:flex; justify-content:space-between; align-items:center; 
            background:var(--bg-card); padding:1rem 1.5rem; border-radius:12px; 
            box-shadow:0 1px 3px rgba(0,0,0,.1); margin-bottom:2rem; 
        }

        .card { 
            background:var(--bg-card); padding:1.5rem; border-radius:12px; 
            box-shadow:0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border-soft); 
            margin-bottom: 1.5rem; 
        }

        .summary-banner {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 1.5rem; background: var(--primary); color: white;
            padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;
        }
        .summary-banner small { color: rgba(255,255,255,0.7); text-transform: uppercase; font-size: 0.7rem; }
        .summary-banner p { font-size: 1.4rem; font-weight: 700; margin-top: 5px; }

        /* --- FILTRES ET ACTIONS --- */
        .action-bar { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 1.5rem; align-items: center; }
        .filter-input { padding: 10px; border-radius: 8px; border: 1px solid var(--border-soft); font-size: 0.9rem; }
        .date-range { display: flex; align-items: center; gap: 8px; background: white; padding: 5px 12px; border-radius: 8px; border: 1px solid var(--border-soft); }

        button { 
            padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; 
            font-weight: 600; font-size: 0.85rem; transition: 0.2s;
        }
        .btn-main { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: #fee2e2; color: var(--danger); }

        /* --- TABLE --- */
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border-soft); background: white; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 800px; }
        th { background: #f8fafc; color: var(--text-light); padding: 14px; text-align: left; border-bottom: 2px solid #edf2f7; }
        td { padding: 12px; border-bottom: 1px solid #edf2f7; }

        .badge-market { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; }
        .local { background: #dbeafe; color: #1e40af; }
        .export { background: #fef3c7; color: #92400e; }

        .logout-box { border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem; margin-top: auto; }
        .logout-btn { display: flex; align-items: center; gap: 12px; padding: 12px 15px; text-decoration: none; color: #ff6b6b; font-weight: 600; }

        /* --- RESPONSIVE --- */
        @media (max-width: 1024px) {
            :root { --sidebar-w: 80px; }
            .sidebar span, .logo-full { display: none; }
            .sidebar .logo-short { display: block; }
        }

        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            .sidebar { 
                width: 100%; height: auto; position: sticky; top: 0; 
                flex-direction: row; padding: 0.5rem; align-items: center;
            }
            .logo-box { border: none; margin: 0; padding: 0 1rem; }
            .nav-links { display: flex; flex-direction: row; overflow-x: auto; scrollbar-width: none; }
            .nav-links a span { display: none; }
            .logout-box { display: none; }
            .main-content { padding: 1rem; height: auto; }
            .summary-banner { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <nav class="sidebar" id="sidebar">
        <div class="logo-box">
            <img src="https://i.postimg.cc/bJjy56Lq/Moniteo_1_removebg_preview.png" class="logo-full" alt="Logo">
            <img src="https://i.postimg.cc/xjgBzxr0/Moniteo-3-removebg-preview.png" class="logo-short" alt="M">
        </div>
        <ul class="nav-links">
            <li><a href="dashboard.html"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg> <span>Accueil</span></a></li>
            <li><a href="sales.html" ><svg class="icon" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg> <span>Ventes</span></a></li>
            <li><a href="inventory.html"><svg class="icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg> <span>Inventaire</span></a></li>
            <li><a href="expenses.html"><svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg> <span>D√©penses</span></a></li>
            <li><a href="staff.html"><svg class="icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg> <span>Staff</span></a></li>
            <li><a href="reporting.html"><svg class="icon" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg> <span>Reporting</span></a></li>
            <li><a href="history.html"class="active"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <span>Historique</span></a></li>
            <li><a href="setting.html"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg> <span>Param√®tres</span></a></li>
        </ul>
        <div class="logout-box">
            <a href="#" onclick="logout(); return false;" class="logout-btn">
                <svg class="icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                <span>D√©connexion</span>
            </a>
        </div>
    </nav>

    <main class="main-content">
        <header class="header-flex">
            <h2>Journal Historique</h2>
            <button class="btn-success" onclick="exportExcel()">Exporter Excel</button>
        </header>

        <div class="summary-banner">
            <div><small>Chiffre d'Affaire</small><p id="caTotal">0 $</p></div>
            <div><small>B√©n√©fice Net</small><p id="profitTotal">0 $</p></div>
            <div><small>Volume Articles</small><p id="qtyTotal">0</p></div>
            <div><small>Transactions</small><p id="transCount">0</p></div>
        </div>

        <div class="action-bar">
            <input type="text" id="searchProd" class="filter-input" placeholder="Rechercher un produit..." oninput="applyFilters()" style="flex:1;">
            
            <div class="date-range">
                <small style="color:var(--text-light)">Du</small>
                <input type="date" id="dateStart" class="filter-input" style="border:none" onchange="applyFilters()">
                <small style="color:var(--text-light)">Au</small>
                <input type="date" id="dateEnd" class="filter-input" style="border:none" onchange="applyFilters()">
            </div>

            <select id="marketFilter" class="filter-input" onchange="applyFilters()">
                <option value="all">Tous March√©s</option>
                <option value="local">Local</option>
                <option value="export">Export</option>
            </select>
            
            <button class="btn-danger" onclick="resetFilters()">R√©initialiser</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Produit</th>
                        <th>March√©</th>
                        <th>Qt√©</th>
                        <th>P.U ($)</th>
                        <th>Total ($)</th>
                        <th>B√©n√©fice ($)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </main>

    <script>
        // --- DONN√âES ---
        let salesHistory = JSON.parse(localStorage.getItem('salesData')) || [];

        function handleResponsiveSidebar() {
            const width = window.innerWidth;
            const sb = document.getElementById('sidebar');
            if (width <= 1024) sb.classList.add('collapsed');
            else sb.classList.remove('collapsed');
        }

        window.addEventListener('resize', handleResponsiveSidebar);
        document.addEventListener('DOMContentLoaded', () => {
            handleResponsiveSidebar();
            renderHistory(salesHistory);
        });
          // √Ä mettre au d√©but de vos fichiers .html (Ventes, Staff, Inventaire)
function applyGlobalSettings() {
    const config = JSON.parse(localStorage.getItem('moniteo_config')) || {};
    
    // 1. Appliquer le th√®me (Sombre/Clair)
    if (config.darkMode) {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }

    // 2. Mettre √† jour la devise globale si n√©cessaire
    if (config.currency) {
        localStorage.setItem('currency', config.currency);
        // Si un s√©lecteur de devise existe sur la page, on le met √† jour
        const select = document.getElementById('currencySelect');
        if (select) select.value = config.currency;
    }

    // 3. Mettre √† jour le titre du dashboard avec le nom de l'entreprise
    const brandName = document.querySelector('.header-flex h2');
    if (brandName && config.name) {
        brandName.innerHTML = `${brandName.innerText} <small style="font-size: 0.6em; color: var(--secondary)">| ${config.name}</small>`;
    }
}
/ Mise √† jour du LOGO
    if (config.logo) {
        // Cible le logo dans la sidebar (la classe .logo-full que tu as d√©j√†)
        const logoImg = document.querySelector('.logo-full');
        if (logoImg) {
            logoImg.src = config.logo;
        }
    }
}

// Ex√©cuter au chargement de chaque page
document.addEventListener('DOMContentLoaded', applyGlobalSettings);
        // --- FILTRAGE ---
        function applyFilters() {
            const query = document.getElementById('searchProd').value.toLowerCase();
            const market = document.getElementById('marketFilter').value;
            const start = document.getElementById('dateStart').value;
            const end = document.getElementById('dateEnd').value;

            const filtered = salesHistory.filter(item => {
                const matchName = item.product.toLowerCase().includes(query);
                const matchMarket = (market === 'all' || item.market === market);
                const matchStart = !start || item.date >= start;
                const matchEnd = !end || item.date <= end;
                return matchName && matchMarket && matchStart && matchEnd;
            });

            renderHistory(filtered);
        }

        function resetFilters() {
            document.getElementById('searchProd').value = '';
            document.getElementById('marketFilter').value = 'all';
            document.getElementById('dateStart').value = '';
            document.getElementById('dateEnd').value = '';
            renderHistory(salesHistory);
        }

        // --- RENDU ---
        function renderHistory(data) {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';
            
            let ca = 0, profit = 0, qty = 0;

            // Inverser pour voir les plus r√©cents en haut
            [...data].reverse().forEach((item, index) => {
                const itemTotal = item.sell * item.qty;
                const itemProfit = (item.sell - item.buy) * item.qty;

                ca += itemTotal;
                profit += itemProfit;
                qty += Number(item.qty);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:500">${formatDate(item.date)}</td>
                    <td style="font-weight:600; color:var(--primary)">${item.product}</td>
                    <td><span class="badge-market ${item.market || 'local'}">${item.market || 'local'}</span></td>
                    <td>${item.qty}</td>
                    <td>${item.sell.toFixed(2)}</td>
                    <td style="font-weight:700">${itemTotal.toFixed(2)}</td>
                    <td style="color:var(--success); font-weight:600">+${itemProfit.toFixed(2)}</td>
                    <td><button class="btn-danger" style="padding:5px 10px" onclick="deleteEntry(${salesHistory.indexOf(item)})">üóë</button></td>
                `;
                tbody.appendChild(tr);
            });

            // Update KPI
            document.getElementById('caTotal').textContent = ca.toFixed(2) + " $";
            document.getElementById('profitTotal').textContent = profit.toFixed(2) + " $";
            document.getElementById('qtyTotal').textContent = qty;
            document.getElementById('transCount').textContent = data.length;
        }

        function formatDate(d) {
            if(!d) return "-";
            const parts = d.split('-');
            return parts.length === 3 ? `${parts[2]}/${parts[1]}/${parts[0]}` : d;
        }

        function deleteEntry(index) {
            if(confirm("Supprimer cette transaction d√©finitivement ?")) {
                salesHistory.splice(index, 1);
                localStorage.setItem('salesData', JSON.stringify(salesHistory));
                applyFilters();
            }
        }

        function exportExcel() {
            const ws = XLSX.utils.json_to_sheet(salesHistory);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Historique");
            XLSX.writeFile(wb, "Moniteo_Historique.xlsx");
        }

        function logout() {
            if(confirm("Se d√©connecter ?")) {
                sessionStorage.clear();
                window.location.href = "index.html";
            }
        }
    </script>
</body>
</html>
