<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moniteo Umbrella - Gestion Staff</title>

    <script>
        if (sessionStorage.getItem('isLogged') !== 'true') {
            window.location.href = "index.html";
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- VARIABLES ET THÃˆMES (CALQUÃ‰S SUR VENTES) --- */
        :root {
            --primary:#1f3c63; --secondary:#3b82f6; --success:#10b981; --danger:#ef4444; --warning:#f59e0b;
            --text-main:#1e293b; --text-light:#64748b; --bg-body:#f1f5f9; --bg-card:#ffffff;
            --border-soft:#e2e8f0; --sidebar-w:260px;
        }

        /* --- RESET ET BASE --- */
        * { margin:0; padding:0; box-sizing:border-box; font-family:Inter,sans-serif; }
        body { display:flex; height: 100vh; overflow: hidden; background:var(--bg-body); color:var(--text-main); transition: 0.3s; }

        .icon { 
            width: 20px; 
            height: 20px; 
            min-width: 20px; 
            stroke: currentColor; 
            stroke-width: 2; 
            fill: none; 
        }

        /* --- SIDEBAR --- */
        .sidebar {
            position: relative; 
            width: var(--sidebar-w); 
            height: 100vh; 
            background: var(--primary);
            color: #fff; 
            padding: 1rem; 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        .sidebar.collapsed { width: 80px; }
        .sidebar.collapsed span, 
        .sidebar.collapsed .logo-full { display: none; }
        .sidebar.collapsed .logo-short { display: block; }

        .logo-box { padding: 1.5rem 0; text-align: center; border-bottom: 1px solid rgba(255,255,255,.1); margin-bottom: 1.5rem; }
        .logo-full { width: 140px; height: auto; }
        .logo-short { display: none; width: 70px; margin: 0 auto; }

        .nav-links { list-style:none; flex:1; overflow-y: auto; }
        .nav-links a {
            display:flex; align-items:center; gap:12px; padding:12px 15px; border-radius:10px;
            text-decoration:none; color:rgba(255,255,255,.7); font-size:.9rem; transition:.2s;
            border-left: 3px solid transparent;
        }
        .nav-links a:hover, .nav-links a.active { background:rgba(255,255,255,0.15); color:#fff; border-left: 3px solid var(--secondary); }

        /* --- CONTENU PRINCIPAL --- */
        .main-content { flex-grow: 1; height: 100vh; overflow-y: auto; padding: 2rem; transition: .3s; }

        .header-flex { 
            display:flex; justify-content:space-between; align-items:center; 
            background:var(--bg-card); padding:1rem 1.5rem; border-radius:12px; 
            box-shadow:0 1px 3px rgba(0,0,0,.1); margin-bottom:2rem; 
        }

        .summary-banner {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 1.5rem; background: var(--primary); color: white;
            padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;
        }
        .summary-banner small { color: rgba(255,255,255,0.7); text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.5px; }
        .summary-banner p { font-size: 1.4rem; font-weight: 700; margin-top: 5px; }

        .card { background:var(--bg-card); padding:1.5rem; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border-soft); margin-bottom: 1.5rem; }

        /* --- TABLES --- */
        .table-wrapper { overflow-x: auto; margin-top: 1rem; border-radius: 8px; border: 1px solid var(--border-soft); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 850px; }
        th { background: #f8fafc; color: var(--text-light); padding: 12px; text-align: left; border-bottom: 2px solid #edf2f7; }
        td { padding: 10px; border-bottom: 1px solid #edf2f7; vertical-align: middle; }

        /* --- BADGES & UI --- */
        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; cursor: pointer; }
        .active-bg { background: #dcfce7; color: #166534; }
        .inactive-bg { background: #fee2e2; color: #991b1b; }
        .contract-badge { background: #f1f5f9; color: #475569; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        
        /* Alertes */
        .expiry-warning { border-left: 4px solid var(--danger) !important; background: #fffcfc; }
        .pulse-alert { display: inline-block; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; margin-right: 5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { transform: scale(0.95); } }

        /* --- ACTIONS --- */
        .action-bar { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        button { padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: 0.2s; white-space: nowrap; }
        .btn-main { background: var(--primary); color: white; }
        .btn-outline { background: white; color: var(--text-main); border: 1px solid var(--border-soft); }
        .btn-danger { background: #fee2e2; color: var(--danger); }

        /* --- MODAL (DOSSIER RH) --- */
        #employeeModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15,23,42,0.8); justify-content:center; align-items:center; z-index:9999; backdrop-filter: blur(4px); }
        .modal-content { background:var(--bg-card); padding:2rem; border-radius:20px; width:95%; max-width:600px; }
        .modal-photo { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; margin: 0 auto 1rem; display: block; border: 3px solid var(--secondary); }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .modal-grid label { font-size: 0.7rem; color: var(--text-light); font-weight: 700; text-transform: uppercase; }
        .modal-grid input, .modal-grid select { width: 100%; padding: 8px; border: 1px solid var(--border-soft); border-radius: 6px; }

        /* --- RESPONSIVE --- */
        @media (max-width: 1024px) {
            :root { --sidebar-w: 80px; }
            .sidebar span, .logo-full { display: none; }
            .sidebar .logo-short { display: block; }
        }

        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            .sidebar { width: 100%; height: auto; position: sticky; top: 0; flex-direction: row; padding: 0.5rem; align-items: center; }
            .logo-box { border: none; margin: 0; padding: 0 1rem; }
            .nav-links { display: flex; flex-direction: row; overflow-x: auto; scrollbar-width: none; }
            .nav-links a span { display: none; }
            .main-content { padding: 1rem; }
            .summary-banner { grid-template-columns: 1fr 1fr; }
        }
        @media print {
    body * { visibility: hidden; }
    #payslipModal, #payslipModal * { visibility: visible; }
    #payslipModal { position: absolute; left: 0; top: 0; width: 100%; background: white !important; }
    .no-print { display: none !important; }
    .modal { background: white !important; }
}
    </style>
</head>
<body>

    <nav class="sidebar" id="sidebar">
        <div class="logo-box">
            <img src="https://i.postimg.cc/bJjy56Lq/Moniteo_1_removebg_preview.png" class="logo-full" alt="Logo">
            <img src="https://i.postimg.cc/xjgBzxr0/Moniteo-3-removebg-preview.png" class="logo-short" alt="M">
        </div>
        <ul class="nav-links">
            <li><a href="dashboard.html"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg> <span>Accueil</span></a></li>
            <li><a href="sales.html"><svg class="icon" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg> <span>Ventes</span></a></li>
            <li><a href="inventory.html"><svg class="icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg> <span>Inventaire</span></a></li>
            <li><a href="expenses.html"><svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg> <span>DÃ©penses</span></a></li>
            <li><a href="staff.html" class="active"><svg class="icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg> <span>Staff</span></a></li>
            <li><a href="reporting.html"><svg class="icon" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg> <span>Reporting</span></a></li>
            <li><a href="history.html"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <span>Historique</span></a></li>
            <li><a href="setting.html"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg> <span>ParamÃ¨tres</span></a></li>
           </ul>        
           <div style="padding: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="#" onclick="logout(); return false;" style="color:#ff6b6b; text-decoration:none; font-size:0.9rem; font-weight:600; display:flex; align-items:center; gap:10px; padding:12px 15px;">
                <svg class="icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                <span>DÃ©connexion</span>
            </a>
        </div>
    </nav>

    <main class="main-content">
        <header class="header-flex">
            <div>
                <h2>Gestion du Personnel</h2>
                <p style="font-size: 0.8rem; color: var(--text-light);">Registre RH & Masse Salariale</p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="searchInput" placeholder="Chercher un nom..." oninput="filterStaff()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-soft);">
            </div>
        </header>

        <div class="summary-banner">
            <div><small>Effectif Total</small><p id="statTotal">0</p></div>
            <div><small>Masse Salariale</small><p id="statMasse">0 $</p></div>
            <div><small>Fin de Contrats</small><p id="statAlerts" style="color:#ff6b6b">0</p></div>
            <div><small>Salaire Moyen</small><p id="statMoyenne">0 $</p></div>
        </div>

        <div class="action-bar">
    <button class="btn-main" onclick="addEmployee()">+ Nouveau Collaborateur</button>
    <button class="btn-outline" onclick="exportStaffExcel()">Exporter Excel</button>
    <button class="btn-outline" onclick="exportStaffPDF()">Exporter PDF</button>
    
    <div style="display: flex; gap: 5px; align-items: center;">
        <button class="btn-outline" onclick="document.getElementById('importExcel').click()">Importer Liste</button>
        <button class="btn-outline" onclick="downloadTemplate()" title="TÃ©lÃ©charger le modÃ¨le" style="display: flex; align-items: center; justify-content: center; padding: 6px 10px;">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaklEQVR4nO3ZTUoDMRjG8T924Ud1IeJe0FO4c9NjzCF0IVYcteAxKvQUegDFO2jBtdClCMLgKwMphGGEafNt88AL7aRJ3x80zdBCTk5Ol2wBI2AKVIAsUHrWCNT8y4JN/wUYh0CMDJpvAiQEYmoZ4B1ROQB4RYgjQF33PhAuAeID4RogrhE+AOIS4QsgrhA+AeICYQroaWt9d5wztokwBRxqa92FQIhhlTaaCAn4Ao5JGCAKcQMcNfZEMgCTMk4GkAFmWSnAJbALXLSMnQPr6jXRAvravAft+qN2fSdmQKHNOwA+VdWP5yliBsyAfW3uGXCqPd8DPmIGCDDR5vYaJ+8k9k0sqgYt65wAP6kA3hsbetPg9yXjrCRgkPJHaJLyJp6l/jVapH6Q9TvcSmyncDM3bBkbqrEr34BqiY1nq6oY/uAwqVcbgNuAgNIGoD5FnwM0/wRs2ADMEdfAm+M9Uan3KG02n5Pzn/MLMavqTUa6Qu4AAAAASUVORK5CYII=" alt="Excel" style="width: 24px; height: 20px;">
        </button>
    </div>
    
    <input type="file" id="importExcel" hidden accept=".xlsx, .xls" onchange="importStaffExcel(event)">
    <button class="btn-danger" onclick="clearStaff()" style="margin-left: auto;">Nettoyer Liste</button>
</div>
        <div class="card">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Collaborateur</th>
                            <th>Poste</th>
                            <th>ID Paie</th>
                            <th>Dates (In/Out)</th>
                            <th>Statut</th>
                            <th>Salaire ($)</th>
                            <th>Bonus ($)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="staffTable"></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>RÃ©partition & Analyse</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; margin-top: 1rem;">
                <div style="height: 250px;"><canvas id="contractChart"></canvas></div>
                <div style="height: 250px;"><canvas id="salaryChart"></canvas></div>
            </div>
        </div>
    </main>

    <div id="employeeModal">
        <div class="modal-content">
            <img id="modalPhoto" class="modal-photo" src="https://via.placeholder.com/100" onclick="document.getElementById('uploadPhoto').click()" style="cursor:pointer">
            <input type="file" id="uploadPhoto" hidden accept="image/*">
            <h3 id="modalNameHeader" style="text-align:center;">Dossier Collaborateur</h3>
            
            <div class="modal-grid">
                <div><label>Nom complet</label><input type="text" id="editName"></div>
                <div><label>Poste / Fonction</label><input type="text" id="editRole"></div>
                <div>
                    <label>Contrat</label>
                    <select id="editContract">
                        <option value="CDI">CDI</option><option value="CDD">CDD</option>
                        <option value="Stage">Stage</option><option value="Freelance">Freelance</option>
                    </select>
                </div>
                <div><label>ID Paie</label><input type="text" id="editID"></div>
                <div><label>Date EntrÃ©e</label><input type="date" id="editEntryDate"></div>
                <div><label>Date Fin (si CDD)</label><input type="date" id="editExpiryDate"></div>
                <div style="grid-column: span 2;"><label>Email Professionnel</label><input type="email" id="editEmail"></div>
            </div>

            <div style="margin-top:25px; display:flex; gap:10px;">
                <button class="btn-main" onclick="saveEmployeeDetails()" style="flex:1">Mettre Ã  jour le dossier</button>
                <button class="btn-outline" onclick="closeModal()" style="flex:1">Fermer</button>
            </div>
        </div>
    </div>
   <div id="payslipModal" class="modal" style="display:none; background:rgba(0,0,0,0.8); position:fixed; top:0; left:0; width:100%; height:100%; justify-content:center; align-items:center; z-index:2000;">
    <div style="background:white; width:600px; padding:0; border-radius:8px; overflow:hidden; position:relative; font-family: 'Segoe UI', Arial, sans-serif;">
        
        <div id="payslipContent" style="padding:40px;">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #1f3c63; padding-bottom:20px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <img src="https://i.postimg.cc/xjgBzxr0/Moniteo-3-removebg-preview.png" style="width:45px;">
                    <h2 style="margin:0; color:#1f3c63;">MONITEO SARL</h2>
                </div>
                <div style="text-align:right;">
                    <h3 style="margin:0; color:#888;">BULLETIN DE PAIE</h3>
                    <small id="psDate"></small>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin:30px 0; padding:15px; background:#f8f9fa; border-radius:5px;">
                <div>
                    <label style="font-size:10px; color:#999; display:block;">NOM COMPLET</label>
                    <strong id="psName" style="font-size:16px;"></strong><br><br>
                    <label style="font-size:10px; color:#999; display:block;">POSTE</label>
                    <span id="psRole"></span>
                </div>
                <div>
                    <label style="font-size:10px; color:#999; display:block;">MATRICULE ID</label>
                    <span id="psID"></span><br><br>
                    <label style="font-size:10px; color:#999; display:block;">CONTRAT</label>
                    <span id="psContract" style="font-weight:bold;"></span>
                </div>
            </div>

            <table style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="border-bottom:2px solid #eee; text-align:left;">
                        <th style="padding:10px 0;">DESCRIPTION</th>
                        <th style="padding:10px 0; text-align:right;">MONTANT</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="border-bottom:1px solid #f1f1f1;">
                        <td style="padding:12px 0;">Salaire de base mensuel</td>
                        <td style="padding:12px 0; text-align:right;" id="psSalary"></td>
                    </tr>
                    <tr style="border-bottom:1px solid #f1f1f1;">
                        <td style="padding:12px 0;">Primes et Bonus</td>
                        <td style="padding:12px 0; text-align:right;" id="psBonus"></td>
                    </tr>
                    <tr style="font-size:18px; font-weight:bold; color:#1f3c63;">
                        <td style="padding:20px 0;">NET Ã€ PAYER ($)</td>
                        <td style="padding:20px 0; text-align:right;" id="psTotal"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="no-print" style="background:#f1f1f1; padding:20px; text-align:center; display:flex; gap:10px; justify-content:center;">
            <button onclick="window.print()" style="background:#1f3c63; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">Imprimer / PDF</button>
            <button onclick="closePayslip()" style="background:#ccc; color:black; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">Fermer</button>
        </div>
    </div>
</div>
<script>
    let staffData = JSON.parse(localStorage.getItem('staffData')) || [];
    let currentIdx = -1;
    let cChart = null;

    // --- RENDU DE LA TABLE ---
    function renderStaff() {
        const tbody = document.getElementById('staffTable');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        const limit = new Date(); 
        limit.setDate(limit.getDate() + 30);

        staffData.forEach((e, i) => {
            let isWarning = false;
            if (e.expiryDate && e.status === 'actif' && new Date(e.expiryDate) <= limit) isWarning = true;

            const tr = document.createElement('tr');
            if(isWarning) tr.classList.add('expiry-warning');

            tr.innerHTML = `
                <td>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${e.photo || 'https://via.placeholder.com/35'}" style="width:35px; height:35px; border-radius:50%; object-fit:cover;">
                        <div>
                            <div style="font-weight:600; cursor:pointer; color:var(--primary)" onclick="openModal(${i})">
                                ${isWarning ? '<span class="pulse-alert"></span>' : ''}${e.name}
                            </div>
                            <span class="contract-badge">${e.contractType}</span>
                        </div>
                    </div>
                </td>
                <td contenteditable="true" onblur="updateField(${i},'role',this.textContent)">${e.role}</td>
                <td contenteditable="true" onblur="updateField(${i},'id',this.textContent)">${e.id}</td>
                <td style="font-size:0.75rem">In: ${e.entryDate}<br><span style="color:var(--danger)">${e.expiryDate ? 'Out: '+e.expiryDate : ''}</span></td>
                <td><span class="status-badge ${e.status==='actif'?'active-bg':'inactive-bg'}" onclick="toggleStatus(${i})">${e.status}</span></td>
                <td contenteditable="true" onblur="updateField(${i},'salary',this.textContent)" style="font-weight:600">${e.salary}</td>
                <td contenteditable="true" onblur="updateField(${i},'bonus',this.textContent)" style="color:var(--success)">${e.bonus}</td>
                <td>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button style="background:none; border:none; cursor:pointer;" onclick="showPayslip(${i})" title="Fiche de paie">
                            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAU0lEQVR4nGNgGG7gPxTbMDAw2FLAJ2gBpRgnGLXgPykWkAr+DzoL/g/5OBjwSP6Ppm7wWfB/NA5G4+A/ORY8poLhj/BZ4EmhJY8YGBg88Fkw9AAAlS4e9UX1elYAAAAASUVORK5CYII=" style="width:18px; height:18px;">
                        </button>
                        <button style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:1.2rem" onclick="removeEmp(${i})" title="Supprimer">ðŸ—‘</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        updateKPIs();
    }

    // --- CALCUL DES STATS ---
    function updateKPIs() {
        const total = staffData.length;
        const masse = staffData.reduce((s, e) => {
            const val = String(e.salary || "0").replace(/[^\d.-]/g, '');
            return s + (parseFloat(val) || 0);
        }, 0);
        
        const now = new Date();
        const limit = new Date(); limit.setDate(now.getDate() + 30);
        const alerts = staffData.filter(e => e.expiryDate && e.status==='actif' && new Date(e.expiryDate) <= limit).length;

        if(document.getElementById('statTotal')) document.getElementById('statTotal').textContent = total;
        if(document.getElementById('statMasse')) document.getElementById('statMasse').textContent = masse.toLocaleString() + " $";
        if(document.getElementById('statAlerts')) document.getElementById('statAlerts').textContent = alerts;
        if(document.getElementById('statMoyenne')) document.getElementById('statMoyenne').textContent = total ? Math.round(masse/total).toLocaleString() + " $" : "0 $";
        
        localStorage.setItem('staffData', JSON.stringify(staffData));
        refreshCharts();
    }

    // --- GRAPHIQUES ---
    function refreshCharts() {
        const canvas = document.getElementById('contractChart');
        if(!canvas) return;
        const ctxC = canvas.getContext('2d');
        const contracts = staffData.reduce((acc, e) => { acc[e.contractType] = (acc[e.contractType] || 0) + 1; return acc; }, {});
        
        if(cChart) cChart.destroy();
        cChart = new Chart(ctxC, {
            type: 'doughnut',
            data: { 
                labels: Object.keys(contracts), 
                datasets: [{ data: Object.values(contracts), backgroundColor: ['#1f3c63','#3b82f6','#10b981','#f59e0b'] }] 
            },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
        });
    }

    // --- ACTIONS COLLABORATEURS ---
    function addEmployee() {
        staffData.unshift({ 
            name:"Nouveau Collaborateur", role:"Poste", contractType:"CDI", 
            id:"PAY-"+Math.floor(Math.random()*999), entryDate:new Date().toISOString().split('T')[0], 
            status:"actif", salary:"0", bonus:"0" 
        });
        renderStaff(); 
        openModal(0);
    }

    function openModal(i) {
        currentIdx = i; const e = staffData[i];
        document.getElementById('editName').value = e.name;
        document.getElementById('editRole').value = e.role;
        document.getElementById('editContract').value = e.contractType;
        document.getElementById('editID').value = e.id;
        document.getElementById('editEntryDate').value = e.entryDate;
        document.getElementById('editExpiryDate').value = e.expiryDate || '';
        document.getElementById('editEmail').value = e.email || '';
        document.getElementById('modalPhoto').src = e.photo || 'https://via.placeholder.com/100';
        document.getElementById('employeeModal').style.display = 'flex';
    }

    function saveEmployeeDetails() {
        const e = staffData[currentIdx];
        e.name = document.getElementById('editName').value;
        e.role = document.getElementById('editRole').value;
        e.contractType = document.getElementById('editContract').value;
        e.id = document.getElementById('editID').value;
        e.entryDate = document.getElementById('editEntryDate').value;
        e.expiryDate = document.getElementById('editExpiryDate').value;
        e.email = document.getElementById('editEmail').value;
        closeModal(); 
        renderStaff();
    }

    function updateField(i, k, v) { 
        staffData[i][k] = v.trim(); 
        updateKPIs(); 
    }

    function toggleStatus(i) { 
        staffData[i].status = staffData[i].status === 'actif' ? 'inactif' : 'actif'; 
        renderStaff(); 
    }

    function removeEmp(i) { 
        if(confirm("Supprimer ce dossier dÃ©finitivement ?")) { 
            staffData.splice(i,1); 
            renderStaff(); 
        } 
    }

    function closeModal() { document.getElementById('employeeModal').style.display = 'none'; }

    // --- IMPORT / EXPORT ---
    function importStaffExcel(ev) {
        const file = ev.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                for (let i = 1; i < rows.length; i++) {
                    const r = rows[i];
                    if (!r || !r[0]) continue;
                    const idImport = String(r[2] || "PAY-IMP");
                    const empObj = {
                        name: r[0], role: r[1], id: idImport, contractType: r[3] || "CDI",
                        status: "actif", salary: String(r[4] || "0"), bonus: String(r[5] || "0"),
                        entryDate: r[6] || new Date().toISOString().split('T')[0], photo: null
                    };
                    const existingIdx = staffData.findIndex(emp => String(emp.id) === idImport);
                    if (existingIdx !== -1) staffData[existingIdx] = { ...staffData[existingIdx], ...empObj };
                    else staffData.push(empObj);
                }
                renderStaff();
                alert("Importation rÃ©ussie !");
            } catch (err) { console.error(err); alert("Erreur de lecture."); }
        };
        reader.readAsArrayBuffer(file);
        ev.target.value = "";
    }

    function exportStaffExcel() {
        const dataToExport = staffData.map(e => ({
            "NOM COMPLET": e.name, "POSTE": e.role, "ID PAIE": e.id, "CONTRAT": e.contractType,
            "SALAIRE": e.salary, "BONUS": e.bonus, "ENTRÃ‰E": e.entryDate, "STATUT": e.status
        }));
        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Personnel");
        XLSX.writeFile(wb, "Moniteo_Staff_Export.xlsx");
    }

    function exportStaffPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("REGISTRE DU PERSONNEL - MONITEO", 14, 15);
        const rows = staffData.map(e => [e.name, e.role, e.id, e.contractType, e.salary + " $"]);
        doc.autoTable({ head: [['Nom', 'Poste', 'ID', 'Contrat', 'Salaire']], body: rows, startY: 25 });
        doc.save('Registre_Moniteo.pdf');
    }

    function downloadTemplate() {
        const headers = [["NOM COMPLET", "POSTE", "ID PAIE", "TYPE CONTRAT", "SALAIRE MENSUEL", "BONUS", "DATE ENTREE"]];
        const ws = XLSX.utils.aoa_to_sheet(headers);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ModÃ¨le");
        XLSX.writeFile(wb, "Moniteo_Modele_Import.xlsx");
    }

    // --- FICHE DE PAIE ---
    function showPayslip(i) {
        const e = staffData[i];
        const parseMoney = (val) => {
            if (!val) return 0;
            const clean = String(val).replace(/[^\d.-]/g, '');
            return parseFloat(clean) || 0;
        };

        const sal = parseMoney(e.salary);
        const bon = parseMoney(e.bonus);
        const total = sal + bon;

        document.getElementById('psName').innerText = e.name;
        document.getElementById('psRole').innerText = e.role || "-";
        document.getElementById('psID').innerText = e.id || "N/A";
        document.getElementById('psContract').innerText = e.contractType || "CDI";
        document.getElementById('psSalary').innerText = sal.toLocaleString('en-US', { minimumFractionDigits: 2 }) + " $";
        document.getElementById('psBonus').innerText = bon.toLocaleString('en-US', { minimumFractionDigits: 2 }) + " $";
        document.getElementById('psTotal').innerText = total.toLocaleString('en-US', { minimumFractionDigits: 2 }) + " $";
        
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('psDate').innerText = "Le " + new Date().toLocaleDateString('fr-FR', options);
        document.getElementById('payslipModal').style.display = 'flex';
    }

    function closePayslip() { document.getElementById('payslipModal').style.display = 'none'; }

    window.onload = renderStaff;
</script>
</body>
</html>
